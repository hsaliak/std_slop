build --cxxopt=-std=c++17
build --cxxopt=-fno-exceptions
build --features=-use_header_modules
build --macos_minimum_os=10.15
build --@curl//:http_only=False
build --@curl//:use_mbedtls=True
build --cxxopt="-Wall" --cxxopt="-Wextra" --cxxopt="-Werror"
build --cxxopt="-Werror=unused-function"
build --copt="-O2"

# 2. Universal Hardening (Safe for modern Clang and GCC)
build --copt="-fstack-protector-strong"
build --copt="-D_FORTIFY_SOURCE=2"
build --copt="-D_GLIBCXX_ASSERTIONS"
build --copt="-D_GLIBCXX_DEBUG"

# 3. Handle the "Unused Argument" error for Clang
# This must come BEFORE the specific flags to ensure Clang doesn't choke on GCC flags
build --copt="-Wno-unused-command-line-argument"

# 4. Compiler-Specific Flags
# Bazel automatically triggers :gcc or :clang configs based on the toolchain
build:gcc --copt="-fstack-clash-protection"
build:gcc --copt="-fcf-protection=full"

build:clang --copt="-fstack-clash-protection" # Only if using Clang 11+
# If Clang version varies, keep -Wno-unused-command-line-argument enabled (Line 16)

#------ sanitizer ----
# Common ASan
# --config=asan
build:asan --features=asan
test:asan --features=asan

# macOS: Linker setup
# Tells the binary to look in its own 'runfiles' directory for the toolchain libs
build:asan-macos --linkopt=-Wl,-rpath,@loader_path/../
build:asan-macos --linkopt=-Wl,-rpath,@loader_path/../../external/toolchains_llvm++llvm+llvm_toolchain_llvm/lib
build:asan-macos --linkopt=-Wl,-rpath,@loader_path/../../external/toolchains_llvm++llvm+llvm_toolchain_llvm/lib/clang/17/lib/darwin

# Linux: Linker setup
build:asan-linux --linkopt=-Wl,-z,origin
build:asan-linux --linkopt=-Wl,-rpath='$$ORIGIN/../lib'

# Hermeticity fixes (stops 'undeclared inclusion' errors)
build:asan --copt=-fno-sanitize-ignorelist
build:asan --features=-layering_check

# Apply configs automatically based on Host OS
build --enable_platform_specific_config


# -------


# 6. Per-file handling for external repos
# Use the common Clang flag -Wno-uninitialized which works for most cases
build --per_file_copt="external/.*@-Wno-uninitialized"
# Use the GCC-specific one only for GCC
build:gcc --per_file_copt="external/.*@-Wno-maybe-uninitialized"

build --test_output=errors

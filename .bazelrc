build --cxxopt=-std=c++17
build --cxxopt=-fno-exceptions
build --features=-use_header_modules
build --macos_minimum_os=10.15
build --@curl//:http_only=False
build --@curl//:use_mbedtls=True
build --cxxopt="-Wall" --cxxopt="-Wextra" --cxxopt="-Werror"
build --cxxopt="-Werror=unused-function"
build --copt="-O2"

# 2. Universal Hardening (Safe for modern Clang and GCC)
build --copt="-fstack-protector-strong"
build --copt="-D_FORTIFY_SOURCE=2"
build --copt="-D_GLIBCXX_ASSERTIONS"
build --copt="-D_GLIBCXX_DEBUG"

# 3. Handle the "Unused Argument" error for Clang
# This must come BEFORE the specific flags to ensure Clang doesn't choke on GCC flags
build --copt="-Wno-unused-command-line-argument"

# 4. Compiler-Specific Flags
# Bazel automatically triggers :gcc or :clang configs based on the toolchain
build:gcc --copt="-fstack-clash-protection"
build:gcc --copt="-fcf-protection=full"

build:clang --copt="-fstack-clash-protection" # Only if using Clang 11+
# If Clang version varies, keep -Wno-unused-command-line-argument enabled (Line 16)

#------ sanitizer ----
# Common ASan/TSan
# --config=asan
build:asan --features=asan
test:asan --features=asan

# --config=tsan
build:tsan --features=tsan
test:tsan --features=tsan
build:tsan --copt=-DTHREAD_SANITIZER
test:tsan --copt=-DTHREAD_SANITIZER

# macOS: ASan/TSan are explicitly disabled due to instability on macOS
build:macos --features=-asan
build:macos --features=-tsan

# Linux: Linker setup
build:asan-linux --linkopt=-Wl,-z,origin
build:asan-linux --linkopt=-Wl,-rpath='$$ORIGIN/../lib'

build:tsan-linux --linkopt=-Wl,-z,origin
build:tsan-linux --linkopt=-Wl,-rpath='$$ORIGIN/../lib'

# Hermeticity fixes (stops 'undeclared inclusion' errors)
build:asan --copt=-fno-sanitize-ignorelist
build:asan --features=-layering_check

build:tsan --copt=-fno-sanitize-ignorelist
build:tsan --features=-layering_check

# Apply configs automatically based on Host OS
build --enable_platform_specific_config


# -------


# 6. Per-file handling for external repos
# Use the common Clang flag -Wno-uninitialized which works for most cases
build --per_file_copt="external/.*@-Wno-uninitialized"
# Use the GCC-specific one only for GCC
build:gcc --per_file_copt="external/.*@-Wno-maybe-uninitialized"

build --test_output=errors

# Avoid discarding analysis cache when switching between lint/fix and build
# by ensuring the lint:fix flag is always present.
build --@aspect_rules_lint//lint:fix=false
